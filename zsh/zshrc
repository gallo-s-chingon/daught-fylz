# Enable Powerlevel10k instant prompt. Should stay close to the top of ${HOME}/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-${HOME}/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-${HOME}/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Ensure XDG_BIN_HOME is in PATH
if ! [[ $PATH == "$XDG_BIN_HOME"* ]]; then
  export PATH="$XDG_BIN_HOME:$PATH"
fi

# Set various environment variables
typeset -g POWERLEVEL9K_INSTANT_PROMPT=quiet

export XDG_CONFIG_HOME="$HOME/.config"
export CF="$HOME/.config"
export DOTZ="$CF/zsh"
export RX="$CF/rx"
export NV="$HOME/.lua-is-the-devil"
export NOT="$HOME/notes"
export DX="$HOME/Documents"
export DN="$HOME/Downloads"
export SCS="$DX/webpage"
export FUNCNEST=25000

# Set directory to store zinit and plugs
ZINIT_HOME="${HOME}/.local/share/zinit/zinit.git"

# Download Zinit if it doesn't exist
if [[ ! -d "$ZINIT_HOME" ]]; then
  mkdir -p "$(dirname $ZINIT_HOME)"
  git clone https://github.com/zdharma-continuum/zinit "$ZINIT_HOME"
fi

# Source / load zinit
source "${ZINIT_HOME}/zinit.zsh"

# Load plugins using zinit
zinit ice depth=1; zinit light romkatv/powerlevel10k
zinit light Aloxaf/fzf-tab

# Load completions
autoload -U compinit && compinit
zinit cdreplay -q

# Load Powerlevel10k configuration if it exists
[[ ! -f ${HOME}/.config/p10k.zsh ]] || source ${HOME}/.config/p10k.zsh

# Keybindings
bindkey -e
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward
bindkey '^[w' kill-region

# History settings
HISTSIZE=5000
HISTFILE=${HOME}/.zsh_history
SAVEHIST=$HISTSIZE
HISTDUP=erase

# History options
setopt auto_cd
setopt appendhistory
setopt sharehistory
setopt hist_ignore_space
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_find_no_dups
# Debugging: Ensure files exist and are readable
if [[ -r "$DOTZ/aliases.zsh" ]]; then
  source "$DOTZ/aliases.zsh" > /dev/null 2>&1
else
  echo "Warning: $DOTZ/aliases.zsh not found or not readable"
fi

if [[ -r "$DOTZ/functions.zsh" ]]; then
  source "$DOTZ/functions.zsh" > /dev/null 2>&1
else
  echo "Warning: $DOTZ/functions.zsh not found or not readable"
fi

if [[ -r "$DOTZ" ]]; then
  source "$DOTZ" > /dev/null 2>&1
else
  echo "Warning: $DOTZ not found or not readable"
fi

if [[ -r $(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
  source $(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
else
  echo "Warning: zsh-syntax-highlighting not found or not readable"
fi

if [[ -r $(brew --prefix)/share/zsh-autopair/autopair.zsh ]]; then
  source $(brew --prefix)/share/zsh-autopair/autopair.zsh
else
  echo "Warning: zsh-autopair not found or not readable"
fi

if [[ -r $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
  source $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh
else
  echo "Warning: zsh-autosuggestions not found or not readable"
fi

if [[ -r $(brew --prefix)/share/zsh-completions ]]; then
  source $(brew --prefix)/share/zsh-completions
else
  echo "Warning: zsh-completions not found or not readable"
fi

# Initialize fzf and zoxide
if command -v fzf &> /dev/null; then
  source <(fzf --zsh)
else
  echo "Warning: fzf not found"
fi

if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
else
  echo "Warning: zoxide not found"
fi

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' menu no
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'
